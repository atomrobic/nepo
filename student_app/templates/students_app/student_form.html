{% extends 'students_app/base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 py-6 px-2 sm:px-6 lg:px-12">
  <div class="w-full max-w-[1400px] mx-auto bg-white shadow-2xl rounded-2xl overflow-hidden flex flex-col lg:flex-row">
    
    <!-- Left Side - Image / Info -->
    <div class="lg:w-2/5 bg-gradient-to-br from-indigo-600 to-purple-700 text-white p-8 lg:p-12 relative flex flex-col justify-center">
      <!-- Decorative circles -->
      <div class="absolute top-0 left-0 w-32 h-32 bg-white bg-opacity-10 rounded-full -translate-x-16 -translate-y-16"></div>
      <div class="absolute bottom-0 right-0 w-48 h-48 bg-white bg-opacity-5 rounded-full translate-x-24 translate-y-24"></div>

      <div class="relative z-10">
        <h1 class="text-4xl lg:text-5xl font-bold mb-4 text-center lg:text-left">
          {% if view.object %} Welcome Back! {% else %} Welcome! {% endif %}
        </h1>
        <p class="text-xl lg:text-2xl text-indigo-100 mb-6 text-center lg:text-left">
          {% if view.object %} Update Student Profile {% else %} Join Our Learning Community {% endif %}
        </p>

        <img src="https://images.unsplash.com/photo-1523050854058-8df90110c9f1?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80"
             alt="Student Learning"
             class="w-full h-48 lg:h-64 object-cover rounded-2xl shadow-lg mb-6">

        <div class="grid grid-cols-3 gap-4 text-center mt-6">
          <div>
            <div class="text-2xl font-bold">500+</div>
            <div class="text-sm text-indigo-200">Students</div>
          </div>
          <div>
            <div class="text-2xl font-bold">50+</div>
            <div class="text-sm text-indigo-200">Courses</div>
          </div>
          <div>
            <div class="text-2xl font-bold">98%</div>
            <div class="text-sm text-indigo-200">Success Rate</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Side - Form -->
    <div class="lg:w-3/5 p-6 lg:p-12">
      <div class="max-w-3xl mx-auto">
        <h2 class="text-3xl font-bold text-gray-800 mb-2 text-center">
          {% if view.object %} ‚úèÔ∏è Edit Student {% else %} üßë‚Äçüéì Student Registration {% endif %}
        </h2>
        <p class="text-center text-gray-600 mb-8">
          {% if view.object %} Update student information below {% else %} Fill in the details to register {% endif %}
        </p>

        <form method="post" enctype="multipart/form-data" id="student-form" class="space-y-6" novalidate>
          {% csrf_token %}

          <!-- Personal Info -->
          <div class="bg-gray-50 rounded-xl p-6">
            <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
              <span class="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center text-white text-sm mr-2">1</span>
              Personal Information
            </h3>

            <div class="mb-4">
              <label class="block text-gray-700 font-medium mb-2">Full Name <span class="text-red-500">*</span></label>
              {{ form.name|add_class:"w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition" }}
              <p class="text-red-500 text-sm mt-1 hidden" id="name-error"></p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <label class="block text-gray-700 font-medium mb-2">Email Address <span class="text-red-500">*</span></label>
                {{ form.email|add_class:"w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition" }}
                <p class="text-red-500 text-sm mt-1 hidden" id="email-error"></p>
              </div>
              <div>
                <label class="block text-gray-700 font-medium mb-2">Phone Number <span class="text-red-500">*</span></label>
                {{ form.phone|add_class:"w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition" }}
                <p class="text-red-500 text-sm mt-1 hidden" id="phone-error"></p>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-gray-700 font-medium mb-2">Date of Birth <span class="text-red-500">*</span></label>
                {{ form.dob|add_class:"w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition" }}
                <p class="text-red-500 text-sm mt-1 hidden" id="dob-error"></p>
              </div>
              <div>
                <label class="block text-gray-700 font-medium mb-2">Gender <span class="text-red-500">*</span></label>
                {{ form.gender|add_class:"w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition" }}
                <p class="text-red-500 text-sm mt-1 hidden" id="gender-error"></p>
              </div>
            </div>
          </div>

          <!-- Academic -->
          <div class="bg-gray-50 rounded-xl p-6">
            <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
              <span class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center text-white text-sm mr-2">2</span>
              Academic Information
            </h3>
            <div>
              <label class="block text-gray-700 font-medium mb-2">Course / Department <span class="text-red-500">*</span></label>
              {{ form.course|add_class:"w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-green-400 focus:border-transparent transition" }}
              <p class="text-red-500 text-sm mt-1 hidden" id="course-error"></p>
            </div>
          </div>

          <!-- Documents -->
          <div class="bg-gray-50 rounded-xl p-6">
            <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
              <span class="w-6 h-6 bg-purple-500 rounded-full flex items-center justify-center text-white text-sm mr-2">3</span>
              Documents & Media
            </h3>

            <div class="mb-6">
              <label class="block text-gray-700 font-medium mb-2">Profile Photo</label>
              {{ form.profile_photo|add_class:"block w-full text-gray-700 file:mr-3 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-purple-600 file:text-white hover:file:bg-purple-700 transition cursor-pointer" }}
              <p class="text-red-500 text-sm mt-1 hidden" id="profile-photo-error"></p>
              <p class="text-gray-500 text-sm mt-1">Accepted formats: JPG, PNG, GIF (Max 5MB)</p>
            </div>

            <div>
              <label class="block text-gray-700 font-medium mb-2">Supporting Documents</label>
              <div id="documents-container" class="space-y-3">
                <input type="file" name="documents" accept=".pdf,.doc,.docx,.jpg,.png"
                       class="block w-full text-gray-700 file:mr-3 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-purple-600 file:text-white hover:file:bg-purple-700 transition cursor-pointer">
              </div>
              <p class="text-red-500 text-sm mt-1 hidden" id="documents-error"></p>
              <p class="text-gray-500 text-sm mt-1">Accepted formats: PDF, DOC, DOCX, JPG, PNG (Max 10MB per file)</p>
              <button type="button" id="add-document" class="mt-3 bg-green-600 text-white py-2 px-4 rounded-lg shadow hover:bg-green-700 transition flex items-center">
                Add Another Document
              </button>
            </div>
          </div>

          <!-- Location -->
          <div class="bg-gray-50 rounded-xl p-6">
            <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
              <span class="w-6 h-6 bg-orange-500 rounded-full flex items-center justify-center text-white text-sm mr-2">4</span>
              Location Information
            </h3>

            <div class="mb-4">
              <label class="block text-gray-700 font-medium mb-2">Address <span class="text-red-500">*</span></label>
              {{ form.address|add_class:"w-full border border-gray-300 rounded-lg p-3 bg-white focus:ring-2 focus:ring-orange-400 focus:border-transparent transition" }}
              <p class="text-red-500 text-sm mt-1 hidden" id="address-error"></p>
            </div>

            <div>
              <label class="block text-gray-700 font-medium mb-2">Select Location on Map</label>
              <div id="map" class="w-full h-64 rounded-lg border border-gray-300 shadow-sm"></div>
              <p class="text-sm text-gray-500 mt-2">Click on the map or drag the marker to set your location</p>
              <p class="text-red-500 text-sm mt-1 hidden" id="location-error"></p>
              <div class="flex justify-end mt-3">
                <button type="button" id="current-location-btn"
                        class="bg-blue-600 text-white py-2 px-4 rounded-lg shadow hover:bg-blue-700 transition flex items-center">
                  üìç Use Current Location
                </button>
              </div>
            </div>
          </div>

          <!-- Hidden Fields -->
          <input type="hidden" id="id_latitude" name="latitude" value="{{ form.latitude.value|default:'' }}">
          <input type="hidden" id="id_longitude" name="longitude" value="{{ form.longitude.value|default:'' }}">

          <div class="text-center pt-4">
            <button type="submit" class="bg-indigo-600 text-white py-3 px-12 rounded-lg shadow-md hover:bg-indigo-700 transition transform hover:-translate-y-0.5 font-semibold text-lg">
              {% if view.object %} üìù Update Student {% else %} üíæ Register Student {% endif %}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Leaflet Map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Validation Functions
  const validators = {
    name: (value) => {
      if (!value || value.trim().length === 0) return 'Name is required';
      if (value.trim().length < 3) return 'Name must be at least 3 characters';
      if (!/^[a-zA-Z\s]+$/.test(value)) return 'Name should only contain letters and spaces';
      return null;
    },
    email: (value) => {
      if (!value || value.trim().length === 0) return 'Email is required';
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(value)) return 'Please enter a valid email address';
      return null;
    },
    phone: (value) => {
      if (!value || value.trim().length === 0) return 'Phone number is required';
      const phoneRegex = /^[0-9]{10}$/;
      if (!phoneRegex.test(value.replace(/[\s\-\(\)]/g, ''))) return 'Please enter a valid 10-digit phone number';
      return null;
    },
    dob: (value) => {
      if (!value || value.trim().length === 0) return 'Date of birth is required';
      const date = new Date(value);
      const today = new Date();
      const age = today.getFullYear() - date.getFullYear();
      if (isNaN(date.getTime())) return 'Please enter a valid date';
      if (age < 5) return 'Student must be at least 5 years old';
      if (age > 100) return 'Please enter a valid date of birth';
      return null;
    },
    gender: (value) => {
      if (!value || value.trim().length === 0) return 'Gender is required';
      return null;
    },
    course: (value) => {
      if (!value || value.trim().length === 0) return 'Course is required';
      return null;
    },
    address: (value) => {
      if (!value || value.trim().length === 0) return 'Address is required';
      if (value.trim().length < 10) return 'Address should be at least 10 characters';
      return null;
    }
  };

  // Validate Field Function
  function validateField(fieldName, value) {
    const errorElement = document.getElementById(`${fieldName}-error`);
    const inputElement = document.querySelector(`[name="${fieldName}"]`);
    
    if (!errorElement || !inputElement) return true;
    
    const error = validators[fieldName] ? validators[fieldName](value) : null;
    
    if (error) {
      errorElement.textContent = error;
      errorElement.classList.remove('hidden');
      inputElement.classList.add('border-red-500');
      inputElement.classList.remove('border-gray-300');
      return false;
    } else {
      errorElement.classList.add('hidden');
      inputElement.classList.remove('border-red-500');
      inputElement.classList.add('border-gray-300');
      return true;
    }
  }

  // File Validation
  function validateFile(file, maxSize, allowedTypes) {
    if (file.size > maxSize) {
      return `File size must be less than ${maxSize / (1024 * 1024)}MB`;
    }
    const fileExt = file.name.split('.').pop().toLowerCase();
    if (!allowedTypes.includes(fileExt)) {
      return `Invalid file type. Allowed: ${allowedTypes.join(', ')}`;
    }
    return null;
  }

  // Attach Real-time Validation to Form Fields
  const fields = ['name', 'email', 'phone', 'dob', 'gender', 'course', 'address'];
  
  fields.forEach(fieldName => {
    const input = document.querySelector(`[name="${fieldName}"]`);
    if (input) {
      input.addEventListener('blur', () => validateField(fieldName, input.value));
      input.addEventListener('input', () => {
        if (input.classList.contains('border-red-500')) {
          validateField(fieldName, input.value);
        }
      });
    }
  });

  // Profile Photo Validation
  const profilePhotoInput = document.querySelector('[name="profile_photo"]');
  if (profilePhotoInput) {
    profilePhotoInput.addEventListener('change', (e) => {
      const errorElement = document.getElementById('profile-photo-error');
      const file = e.target.files[0];
      
      if (file) {
        const error = validateFile(file, 5 * 1024 * 1024, ['jpg', 'jpeg', 'png', 'gif']);
        if (error) {
          errorElement.textContent = error;
          errorElement.classList.remove('hidden');
          e.target.value = '';
        } else {
          errorElement.classList.add('hidden');
        }
      }
    });
  }

  // Documents Validation
  const documentsContainer = document.getElementById('documents-container');
  documentsContainer.addEventListener('change', (e) => {
    if (e.target.type === 'file') {
      const errorElement = document.getElementById('documents-error');
      const file = e.target.files[0];
      
      if (file) {
        const error = validateFile(file, 10 * 1024 * 1024, ['pdf', 'doc', 'docx', 'jpg', 'jpeg', 'png']);
        if (error) {
          errorElement.textContent = error;
          errorElement.classList.remove('hidden');
          e.target.value = '';
        } else {
          errorElement.classList.add('hidden');
        }
      }
    }
  });

  // Form Submission Validation
  const form = document.getElementById('student-form');
  form.addEventListener('submit', (e) => {
    let isValid = true;
    
    // Validate all required fields
    fields.forEach(fieldName => {
      const input = document.querySelector(`[name="${fieldName}"]`);
      if (input && !validateField(fieldName, input.value)) {
        isValid = false;
      }
    });

    // Validate location
    const latInput = document.getElementById('id_latitude');
    const lngInput = document.getElementById('id_longitude');
    const locationError = document.getElementById('location-error');
    
    if (!latInput.value || !lngInput.value) {
      locationError.textContent = 'Please select a location on the map';
      locationError.classList.remove('hidden');
      isValid = false;
    } else {
      locationError.classList.add('hidden');
    }

    if (!isValid) {
      e.preventDefault();
      // Scroll to first error
      const firstError = document.querySelector('.border-red-500');
      if (firstError) {
        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }
  });

  // Map Functionality
  const defaultLoc = [10.8505, 76.2711];
  const map = L.map('map').setView(defaultLoc, 7);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

  const latInput = document.getElementById('id_latitude');
  const lngInput = document.getElementById('id_longitude');
  const addressInput = document.querySelector('[name="address"]');
  let marker = L.marker(defaultLoc, { draggable: true }).addTo(map);

  function reverseGeocode(lat, lng) {
    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
      .then(res => res.json())
      .then(data => { 
        if (data?.display_name) {
          addressInput.value = data.display_name;
          validateField('address', data.display_name);
        }
      })
      .catch(() => { 
        addressInput.value = `Lat: ${lat}, Lng: ${lng}`;
      });
  }

  function updateMarker(latlng) {
    latInput.value = latlng.lat.toFixed(6);
    lngInput.value = latlng.lng.toFixed(6);
    reverseGeocode(latlng.lat, latlng.lng);
    
    // Clear location error
    const locationError = document.getElementById('location-error');
    locationError.classList.add('hidden');
  }

  marker.on('dragend', () => updateMarker(marker.getLatLng()));
  map.on('click', e => { 
    marker.setLatLng(e.latlng); 
    updateMarker(e.latlng); 
  });

  // Use current location button
  const currentLocBtn = document.getElementById('current-location-btn');
  currentLocBtn.addEventListener('click', () => {
    if (navigator.geolocation) {
      currentLocBtn.disabled = true;
      currentLocBtn.textContent = 'üìç Loading...';
      
      navigator.geolocation.getCurrentPosition(
        pos => {
          const userLoc = [pos.coords.latitude, pos.coords.longitude];
          map.setView(userLoc, 13);
          marker.setLatLng(userLoc);
          updateMarker(marker.getLatLng());
          currentLocBtn.disabled = false;
          currentLocBtn.textContent = 'üìç Use Current Location';
        },
        err => { 
          alert("Unable to fetch your location. Please allow location access.");
          currentLocBtn.disabled = false;
          currentLocBtn.textContent = 'üìç Use Current Location';
        }
      );
    } else {
      alert("Geolocation is not supported by your browser.");
    }
  });

  // Auto-load user location on page load
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      const userLoc = [pos.coords.latitude, pos.coords.longitude];
      map.setView(userLoc, 13);
      marker.setLatLng(userLoc);
      updateMarker(marker.getLatLng());
    }, () => updateMarker(marker.getLatLng()));
  } else {
    updateMarker(marker.getLatLng());
  }

  if (latInput.value && lngInput.value) {
    const existingLoc = [parseFloat(latInput.value), parseFloat(lngInput.value)];
    map.setView(existingLoc, 13); 
    marker.setLatLng(existingLoc);
    if (!addressInput.value) reverseGeocode(existingLoc[0], existingLoc[1]);
  }

  // Add Document Inputs
  const addBtn = document.getElementById('add-document');
  addBtn.addEventListener('click', () => {
    const newInput = document.createElement('input');
    newInput.type = 'file';
    newInput.name = 'documents';
    newInput.accept = ".pdf,.doc,.docx,.jpg,.png";
    newInput.className = "block w-full text-gray-700 file:mr-3 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-purple-600 file:text-white hover:file:bg-purple-700 transition cursor-pointer";
    documentsContainer.appendChild(newInput);
  });
});
</script>
{% endblock %}